<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext
    https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

   <changeSet id="add-version-to-rules-config" author="system">
    <sql>
       UPDATE actions_config
      SET config = jsonb_set(
          config,
          '{rules}',
          (
              SELECT COALESCE(
                  jsonb_agg(
                      CASE
                          WHEN (rule->>'version') IS NULL
                              THEN rule || jsonb_build_object('version', '1.0.0')
                          ELSE rule
                      END
                  ),
                  '[]'::jsonb
              )
              FROM jsonb_array_elements(config->'rules') AS rule
          )
      )
      WHERE config->'rules' IS NOT NULL;
    </sql>
   </changeSet>
</databaseChangeLog>
