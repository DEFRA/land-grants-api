<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext
    https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

   <changeSet id="update-action-config-duration-years" author="system">
    <sql>UPDATE actions_config SET config = jsonb_set(config, '{duration_years}', '1') WHERE (code = 'CMOR1' OR code = 'UPL1' OR code = 'UPL2' OR code = 'UPL3') AND version = 1;</sql>
  </changeSet>

    <changeSet id="add-description-to-actions-rule" author="system">
    <sql>
       UPDATE actions_config
      SET config = jsonb_set(
          config,
          '{rules}',
          (
              SELECT COALESCE(
                  jsonb_agg(
                      rule || jsonb_build_object(
                          'description',
                          CASE
                              WHEN rule->>'name' = 'parcel-has-intersection-with-data-layer'
                                  THEN 'Is this parcel on the moorland?'
                              WHEN rule->>'name' = 'applied-for-total-available-area'
                                  THEN 'Has the total available area been applied for?'
                              ELSE ''
                          END
                      )
                  ),
                  '[]'::jsonb
              )
              FROM jsonb_array_elements(config->'rules') AS rule
          )
      )
      WHERE config->'rules' IS NOT NULL;
    </sql>
    <rollback>
        <sql>
            UPDATE actions_config
            SET config = jsonb_set(config, '{rules}', config->'rules')
            WHERE config->'rules' IS NOT NULL;
        </sql>
    </rollback>
  </changeSet>

</databaseChangeLog>
